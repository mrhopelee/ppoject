<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>瀑布流二</title>
    <!-- External CSS all-->
    <link rel="stylesheet" href="http://libs.useso.com/js/bootstrap/3.2.0/css/bootstrap.css">
    <!-- In-document CSS -->
    <style>
        .HomePage {
            width: 1250px;
            margin: 0 auto;
        }

        @media all and (max-width: 1250px) {
            .HomePage {
                width: 1000px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 1000px) {
            .HomePage {
                width: 750px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 750px) {
            .HomePage {
                width: 500px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 500px) {
            .HomePage {
                width: 250px;
                margin: 0 auto;
            }
        }

        .Module {
            /*width: 250px;
            margin: 30px auto;*/
            /*text-align: center;*/
            position: relative;
            /*overflow: hidden;*/
            /*background-color: #DDDDDD;*/
        }

        .item {
            margin: 14px 7px 0 7px;
            width: 236px;
        }

        /*.i1 {
            position: absolute;
            left:200px;
            top: 200px;
        }*/

        .item > a > img {
            width: 100%;
        }

    </style>
    <!-- External JavaScript all -->
    <script src="http://libs.useso.com/js/jquery/2.1.1/jquery.js"></script>
    <script src="http://libs.useso.com/js/bootstrap/3.2.0/js/bootstrap.js"></script>
    <!--<script src="javascript/masonry.pkgd.js"></script>-->
    <!-- In-document JavaScript -->

</head>
<body>
<div class="HomePage">
    <div class="Module">
        <div class="item i1"><a href=""><img src="pblimg/P_001.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_002.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_003.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_004.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_005.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_006.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_007.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_008.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_009.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_010.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_011.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_012.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_013.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_014.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_015.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_016.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_017.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_018.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_019.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_020.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_021.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_022.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_023.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_024.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_025.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_026.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_027.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_028.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_029.jpg" alt=""/></a></div>
        <div class="item"><a href=""><img src="pblimg/P_030.jpg" alt=""/></a></div>
    </div>
</div>
<script>
/*
    var moudle = $(".Module"), /!*容器*!/
    b = 250, /!*容器内单个单位宽度*!/
    mw, /!*容器宽度*!/
    c;
    /!*每行单位数*!/
    var temp = 31;
    /!*第一张未加载的图片*!/
    var max = 160;
    /!*图片总数*!/

    function initch() {
        mw = moudle.width();
        c = mw / b;
        var arr = new Array(c);
        for (var i = 0; i < c; i++) {
            arr[i] = 0;
        }
        return arr;
    }
    function mins(p) {
        return p.indexOf(Math.min.apply(null, p));
        /!*获取高度最小的列*!/
    }
    function minh(p) {
        return Math.min.apply(null, p);
        /!*获取高度最小的列的高度*!/
    }
    $(window).resize(function () {
        mw = moudle.width();
        c = mw / b;
        console.log("mw :" + mw + "c :" + c);
        rmove();
    });

    var timer = null;
    $(document).scroll(function () {
        if (temp <= max) {
            if (timer) {
                clearTimeout(timer);
                timer = null;
            }
            timer = setTimeout(function () {
                whenscroll();
            }, 300);
        }
    });

    function whenscroll() {
        if (temp <= max) {
            var getHeight = $(document).scrollTop() + (window.innerHeight || document.documentElement.clientHeight);
            if (moudle.offset().top + moudle.height() < getHeight) {
                append({l: moudle});
            }
        }
    }

    function append(parameters) {
        var str = null;
        if (temp <= max) {
            if (temp < 100) {
                str = "<div class=\"item\"><a href=\"\"><img src=\"pblimg/P_0" + temp + ".jpg\" alt=\"\"/></a></div>"
                temp++;
            } else {
                str = "<div class=\"item\"><a href=\"\"><img src=\"pblimg/P_" + temp + ".jpg\" alt=\"\"/></a></div>"
                temp++;
            }
            var l = parameters.l;
            l.append(str);
            rmove();
            return this;
        } else {
            return this;
        }
    }


    function rmove() {
        var item = moudle.children("div");
        /!*console.log("共" + item.length + "个item");*!/
        var ch = initch();
        var minsite, now_top, now_left;
        for (var i = 0; i < item.length; i++) {
            var now = item.eq(i);
            minsite = mins(ch);
            now_left = minsite * b;
            now_top = ch[minsite];
            now.css({
                "position": "absolute",
                "left": now_left + "px",
                "top": now_top + "px"
            });
            ch[minsite] = ch[minsite] + now.height() + 14;

        }
        moudle.height(minh(ch));
        /!*console.log("offset top :" + moudle.offset().top + "height :" + moudle.height());*!/
        if (timer) {
            clearTimeout(timer);
            timer = null;
        }
        timer = setTimeout(function () {
            whenscroll();
        }, 100);
        return 0;
    }
*/
(function ($) {
    var
            props = ['Width', 'Height'],
            prop;

    while (prop = props.pop()) {
        (function (natural, prop) {
            $.fn[natural] = (natural in new Image()) ?
                    function () {
                        return this[0][natural];
                    } :
                    function () {
                        var
                                node = this[0],
                                img,
                                value;

                        if (node.tagName.toLowerCase() === 'img') {
                            img = new Image();
                            img.src = node.src;
                            value = img[prop];
                        }
                        return value;
                    };
        }('natural' + prop, prop.toLowerCase()));
    }
}(jQuery));
var waterFall = {
    wFmoudle: $(".Module"), /*容器*/
    itemWidth: 250, /*容器内单个元素单位宽度*/
    max: 160, /*图片总数*/
    arr: null,
    stop: null,
    getColumnHeight: function () {/*每列高度数组*/
        var c = this.wFmoudle.width() / this.itemWidth;
        /*（列数=容器宽度/单位宽度）*/
        if (this.arr == null) {
            this.arr = new Array(c);
            for (var i = 0; i < c; i++) {
                this.arr[i] = 0;
            }
        }
        return this.arr;
    },
    getMinSite: function (p) {/*获取高度最小的列*/
        return p.indexOf(Math.min.apply(null, p));
    },
    getMinHeight: function (p) {/*获取高度最小的列的高度*/
        return Math.min.apply(null, p);
    },
    getAllItem: function () {/*获取容器内所有元素*/
        return this.wFmoudle.children("div");
    },
    /*getLastItem: function () {/!*获取容器内最新添加的元素*!/
        /!*console.log(this.wFmoudle.children("div").length);
         console.log(this.wFmoudle.children("div").last().height());*!/
        return this.wFmoudle.children("div").last();
    },*/
    appdneListen: function () {
        var self = this;
        var getHeight = $(document).scrollTop() + (window.innerHeight || document.documentElement.clientHeight);
        if (self.wFmoudle.offset().top + self.wFmoudle.height() < getHeight) {
            self.appendItem({m: self.wFmoudle});
        }
        return this;
    },
    appendItem: function (parameters) {/*添加元素*/
        var str = null;
        var self = this;
        var allItem = this.getAllItem();
        if (allItem.length + 1 <= this.max) {
            if (allItem.length + 1 < 100) {
                str = "<div class=\"item\"><a href=\"\"><img src=\"pblimg/P_0" + (allItem.length + 1) + ".jpg\" alt=\"\"/></a></div>"
            } else {
                str = "<div class=\"item\"><a href=\"\"><img src=\"pblimg/P_" + (allItem.length + 1) + ".jpg\" alt=\"\"/></a></div>"
            }
            var m = parameters.m;
            m.append(str);

            m.find("img").last().load(function () {
                while (m.find("img").last().naturalHeight() == 0) {
                }
                /*console.log(m.find("img").last().naturalHeight()+" "+m.children("div").last().height());*/
                self.wFlast(m);
            });
            /*self.stop = setTimeout(function () {
             self.wFlast(m);
             }, 100);*/
        }
        return this;
    },
    wFlast: function (m) {/*容器内最后添加的元素按瀑布流排列*/
        var lastItem = m.children("div").last();
        var columnHeight = this.getColumnHeight();
        var self = this;
        var minSite = self.getMinSite(columnHeight);
        lastItem.css({
            "position": "absolute",
            "left": minSite * self.itemWidth + "px",
            "top": columnHeight[minSite] + "px"
        });
        columnHeight[minSite] = columnHeight[minSite] + lastItem.height() + 14;
        /*console.log(columnHeight);*/
        self.wFmoudle.height(self.getMinHeight(columnHeight));
        clearTimeout(self.stop);
        self.stop = null;
        self.appdneListen();
        return this;
    },
    wFall: function () {/*容器内所有元素按瀑布流排列*/
        this.arr = null;
        var allItem = this.getAllItem();
        var columnHeight = this.getColumnHeight();
        var self = this;
        var minSite, nowItemTop, nowItemLeft;
        for (var i = 0; i < allItem.length; i++) {
            var nowItem = allItem.eq(i);
            minSite = self.getMinSite(columnHeight);
            nowItemLeft = minSite * self.itemWidth;
            nowItemTop = columnHeight[minSite];
            nowItem.css({
                "position": "absolute",
                "left": nowItemLeft + "px",
                "top": nowItemTop + "px"
            });
            columnHeight[minSite] = columnHeight[minSite] + nowItem.height() + 14;
        }
        self.wFmoudle.height(self.getMinHeight(columnHeight));
        self.appdneListen();
        return this;
    },
    wFscroll: function () {/*滚动监听，当导航条高度改变*/
        var self = this;
        var timer = null;
        $(document).scroll(function () {
            if (self.stop) {
                return this;
            }
            if (timer) {
                clearTimeout(timer);
            }
            timer = setTimeout(function () {
                self.appdneListen();
            }, 300);
        });
        return this;
    },
    wFresize: function () {/*窗口监听，当容器宽高改变*/
        var self = this;
        var timer = null;
        $(window).resize(function () {
            if (timer) {
                clearTimeout(timer);
            }
            timer = setTimeout(function () {
                self.wFmoudle.height(0);
                self.wFall();
            }, 100);
        });
        return this;
    },
    init: function () {
        if (this.wFmoudle) {
            this.wFmoudle.height(0);
            this.arr = null;
            this.wFall().wFscroll().wFresize();
        }
    }
};

setTimeout(function () {
    waterFall.init();
}, 100);


</script>
</body>
</html>