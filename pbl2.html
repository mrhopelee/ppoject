<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>瀑布流二</title>
    <!-- External CSS all-->
    <link rel="stylesheet" href="http://libs.useso.com/js/bootstrap/3.2.0/css/bootstrap.css">
    <!-- In-document CSS -->
    <style>
        .HomePage {
            width: 1250px;
            margin: 0 auto;
        }

        @media all and (max-width: 1250px) {
            .HomePage {
                width: 1000px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 1000px) {
            .HomePage {
                width: 750px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 750px) {
            .HomePage {
                width: 500px;
                margin: 0 auto;
            }
        }

        @media all and (max-width: 500px) {
            .HomePage {
                width: 250px;
                margin: 0 auto;
            }
        }

        .Module {
            position: relative;
        }

        .Module > div {
            margin: 14px 7px 0 7px;
            width: 236px;
        }

        .item > a > img {
            width: 100%;
        }

    </style>
    <!-- External JavaScript all -->
    <script src="http://libs.useso.com/js/jquery/2.1.1/jquery.js"></script>
    <script src="http://libs.useso.com/js/bootstrap/3.2.0/js/bootstrap.js"></script>
    <!--<script src="javascript/masonry.pkgd.js"></script>-->
    <!-- In-document JavaScript -->

</head>
<body>
<div class="HomePage">
    <div class="Module">
        <div><a href=""><img src="pblimg/P_000.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_001.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_002.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_003.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_004.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_005.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_006.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_007.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_008.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_009.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_010.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_011.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_012.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_013.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_014.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_015.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_016.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_017.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_018.jpg" alt=""/></a></div>
        <div><a href=""><img src="pblimg/P_019.jpg" alt=""/></a></div>
    </div>
</div>
<script>

    /* jquery扩展，naturalHeight()，获取图片原始高度*/
    /*(function ($) {
     var
     props = ['Width', 'Height'],
     prop;

     while (prop = props.pop()) {
     (function (natural, prop) {
     $.fn[natural] = (natural in new Image()) ?
     function () {
     return this[0][natural];
     } :
     function () {
     var
     node = this[0],
     img,
     value;

     if (node.tagName.toLowerCase() === 'img') {
     img = new Image();
     img.src = node.src;
     value = img[prop];
     }
     return value;
     };
     }('natural' + prop, prop.toLowerCase()));
     }
     }(jQuery));*/
    /* 生成json数组pic*/
    /*var getpic = {
     con: function () {
     var pic = {
     "pnames": ["P_000", "P_001", "P_002", "P_003", "P_004", "P_005", "P_006", "P_007", "P_008", "P_009", "P_010", "P_011", "P_012", "P_013", "P_014", "P_015", "P_016", "P_017", "P_018", "P_019", "P_020", "P_021", "P_022", "P_023", "P_024", "P_025", "P_026", "P_027", "P_028", "P_029", "P_030", "P_031", "P_032", "P_033", "P_034", "P_035", "P_036", "P_037", "P_038", "P_039", "P_040", "P_041", "P_042", "P_043", "P_044", "P_045", "P_046", "P_047", "P_048", "P_049", "P_050", "P_051", "P_052", "P_053", "P_054", "P_055", "P_056", "P_057", "P_058", "P_059", "P_060", "P_061", "P_062", "P_063", "P_064", "P_065", "P_066", "P_067", "P_068", "P_069", "P_070", "P_071", "P_072", "P_073", "P_074", "P_075", "P_076", "P_077", "P_078", "P_079", "P_080", "P_081", "P_082", "P_083", "P_084", "P_085", "P_086", "P_087", "P_088", "P_089", "P_090", "P_091", "P_092", "P_093", "P_094", "P_095", "P_096", "P_097", "P_098", "P_099", "P_100", "P_101", "P_102", "P_103", "P_104", "P_105", "P_106", "P_107", "P_108", "P_109", "P_110", "P_111", "P_112", "P_113", "P_114", "P_115", "P_116", "P_117", "P_118", "P_119", "P_120", "P_121", "P_122", "P_123", "P_124", "P_125", "P_126", "P_127", "P_128", "P_129", "P_130", "P_131", "P_132", "P_133", "P_134", "P_135", "P_136", "P_137", "P_138", "P_139", "P_140", "P_141", "P_142", "P_143", "P_144", "P_145", "P_146", "P_147", "P_148", "P_149", "P_150", "P_151", "P_152", "P_153", "P_154", "P_155", "P_156", "P_157", "P_158", "P_159", "P_160"],
     "pheights": [354, 354, 354, 159, 349, 311, 301, 422, 293, 195, 355, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207, 299, 236, 170, 177, 315, 157, 236, 236, 236, 279, 148, 334, 328, 328, 354, 338, 157, 349, 189, 293, 329, 356, 334, 342, 155, 354, 236, 390, 314, 148, 328, 340, 340, 354, 354, 354, 159, 349, 311, 301, 422, 293, 195, 355, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207, 299, 236, 170, 177, 315, 157, 236, 236, 236, 279, 148, 334, 328, 328, 354, 338, 157, 349, 189, 293, 329, 356, 334, 342, 155, 354, 236, 390, 314, 148, 328, 340, 340, 354, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207],
     };
     /!*pic.pname = [];
     pic.pheight = [];*!/

     var all = $("img");
     for (var i = 0; i < all.length; i++) {
     if (i < 10) {
     pic.pnames[i] = "P_00" + i;
     } else if (i >= 10 && i < 100) {
     pic.pnames[i] = "P_0" + i;
     } else {
     pic.pnames[i] = "P_" + i;
     }

     pic.pheights[i] = all.eq(i).naturalHeight();
     }
     var pnames = pic.pnames;
     var str = "";
     for (var j in pnames) {
     str = str + "\"" + pnames[j] + "\"" + ", "
     }
     console.log(str);
     var pheights = pic.pheights;
     var str = "";
     for (var k in pheights) {
     str = str + pheights[k] + ", "
     }
     console.log(str);
     return this;
     }
     };*/

    var pic = {
        /*图片名，图片高*/
        "pnames": ["P_000", "P_001", "P_002", "P_003", "P_004", "P_005", "P_006", "P_007", "P_008", "P_009", "P_010", "P_011", "P_012", "P_013", "P_014", "P_015", "P_016", "P_017", "P_018", "P_019", "P_020", "P_021", "P_022", "P_023", "P_024", "P_025", "P_026", "P_027", "P_028", "P_029", "P_030", "P_031", "P_032", "P_033", "P_034", "P_035", "P_036", "P_037", "P_038", "P_039", "P_040", "P_041", "P_042", "P_043", "P_044", "P_045", "P_046", "P_047", "P_048", "P_049", "P_050", "P_051", "P_052", "P_053", "P_054", "P_055", "P_056", "P_057", "P_058", "P_059", "P_060", "P_061", "P_062", "P_063", "P_064", "P_065", "P_066", "P_067", "P_068", "P_069", "P_070", "P_071", "P_072", "P_073", "P_074", "P_075", "P_076", "P_077", "P_078", "P_079", "P_080", "P_081", "P_082", "P_083", "P_084", "P_085", "P_086", "P_087", "P_088", "P_089", "P_090", "P_091", "P_092", "P_093", "P_094", "P_095", "P_096", "P_097", "P_098", "P_099", "P_100", "P_101", "P_102", "P_103", "P_104", "P_105", "P_106", "P_107", "P_108", "P_109", "P_110", "P_111", "P_112", "P_113", "P_114", "P_115", "P_116", "P_117", "P_118", "P_119", "P_120", "P_121", "P_122", "P_123", "P_124", "P_125", "P_126", "P_127", "P_128", "P_129", "P_130", "P_131", "P_132", "P_133", "P_134", "P_135", "P_136", "P_137", "P_138", "P_139", "P_140", "P_141", "P_142", "P_143", "P_144", "P_145", "P_146", "P_147", "P_148", "P_149", "P_150", "P_151", "P_152", "P_153", "P_154", "P_155", "P_156", "P_157", "P_158", "P_159", "P_160"],
        "pheights": [354, 354, 354, 159, 349, 311, 301, 422, 293, 195, 355, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207, 299, 236, 170, 177, 315, 157, 236, 236, 236, 279, 148, 334, 328, 328, 354, 338, 157, 349, 189, 293, 329, 356, 334, 342, 155, 354, 236, 390, 314, 148, 328, 340, 340, 354, 354, 354, 159, 349, 311, 301, 422, 293, 195, 355, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207, 299, 236, 170, 177, 315, 157, 236, 236, 236, 279, 148, 334, 328, 328, 354, 338, 157, 349, 189, 293, 329, 356, 334, 342, 155, 354, 236, 390, 314, 148, 328, 340, 340, 354, 156, 347, 177, 331, 347, 175, 343, 355, 322, 354, 226, 708, 178, 159, 356, 156, 177, 236, 354, 332, 177, 336, 300, 207]
    };

    var waterFall = {
        wFmoudle: $(".Module"), /*容器*/
        itemWidth: 250, /*容器内单个元素单位宽度*/
        max: 160, /*图片总数*/
        arr: null,
        getColumnHeight: function () {/*每列高度数组*/
            var c = this.wFmoudle.width() / this.itemWidth;
            /*（列数=容器宽度/单位宽度）*/
            if (this.arr == null) {
                this.arr = new Array(c);
                for (var i = 0; i < c; i++) {
                    this.arr[i] = 0;
                }
            }
            return this.arr;
        },
        getMinSite: function (p) {/*获取高度最小的列*/
            return p.indexOf(Math.min.apply(null, p));
        },
        getMinHeight: function (p) {/*获取高度最小的列的高度*/
            return Math.min.apply(null, p);
        },
        getAllItem: function () {/*获取容器内所有元素*/
            return this.wFmoudle.children("div");
        },
        appdneListen: function () {
            var self = this;
            var getHeight = $(document).scrollTop() + (window.innerHeight || document.documentElement.clientHeight);
            if (self.wFmoudle.offset().top + self.wFmoudle.height() < getHeight) {
                self.appendItem({m: self.wFmoudle});
            }
            return this;
        },
        appendItem: function (parameters) {/*添加元素*/
            var str = null;
            var self = this;
            var allItem = this.getAllItem();
            if (allItem.length > this.max) {
            } else {
                str = "<div><a href=\"\"><img src=\"pblimg/" + pic.pnames[allItem.length] + ".jpg\" alt=\"\"/></a></div>";
                var m = parameters.m;
                m.append(str);
                self.wFlast(m, pic.pheights[allItem.length]);
            }
            return this;
        },
        wFlast: function (m, pheights) {/*容器内最后添加的元素按瀑布流排列*/
            var lastItem = m.children("div").last();
            var columnHeight = this.getColumnHeight();
            var self = this;
            var minSite = self.getMinSite(columnHeight);
            lastItem.css({
                "position": "absolute",
                "left": minSite * self.itemWidth + "px",
                "top": columnHeight[minSite] + "px"
            });
            columnHeight[minSite] = columnHeight[minSite] + pheights + 14;
            /*console.log(columnHeight);*/
            self.wFmoudle.height(self.getMinHeight(columnHeight));
            lastItem.find("img").load(function () {
                self.appdneListen();
            });
            return this;
        },
        wFall: function () {/*容器内所有元素按瀑布流排列*/
            this.arr = null;
            var allItem = this.getAllItem();
            var columnHeight = this.getColumnHeight();
            var self = this;
            var minSite, nowItemTop, nowItemLeft;
            for (var i = 0; i < allItem.length; i++) {
                var nowItem = allItem.eq(i);
                minSite = self.getMinSite(columnHeight);
                nowItemLeft = minSite * self.itemWidth;
                nowItemTop = columnHeight[minSite];
                nowItem.css({
                    "position": "absolute",
                    "left": nowItemLeft + "px",
                    "top": nowItemTop + "px"
                });
                columnHeight[minSite] = columnHeight[minSite] + nowItem.height() + 14;
            }
            self.wFmoudle.height(self.getMinHeight(columnHeight));
            self.appdneListen();
            return this;
        },
        wFscroll: function () {/*滚动监听，当导航条高度改变*/
            var self = this;
            var timer = null;
            $(document).scroll(function () {
                if (self.stop) {
                    return this;
                }
                if (timer) {
                    clearTimeout(timer);
                }
                timer = setTimeout(function () {
                    self.appdneListen();
                }, 300);
            });
            return this;
        },
        wFresize: function () {/*窗口监听，当容器宽高改变*/
            var self = this;
            var timer = null;
            $(window).resize(function () {
                if (timer) {
                    clearTimeout(timer);
                }
                timer = setTimeout(function () {
                    self.wFmoudle.height(0);
                    self.wFall();
                }, 100);
            });
            return this;
        },
        init: function () {
            if (this.wFmoudle) {
                this.wFmoudle.height(0);
                this.arr = null;
                this.wFall().wFscroll().wFresize();
            }
        }
    };

    setTimeout(function () {
        waterFall.init();
    }, 100);


</script>
</body>
</html>